<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Winicius Chat</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/js/sjcl.js">
<script>
</script>


<script src="/socket.io/socket.io.js"></script>
<script>
	var socket = io();

	socket.on('connect', function(){
		socket.emit('adduser', prompt("What's your name?"));
		$('#data').focus();
	});

	socket.on('updatechat', function (username, data) {
		$('#conversation').append('<div class="row"><b>'+username +
		   ':</b><span>' + data + '</span>' +
		   '<span class="decrypt">Decrypt</span>'+
		   '<br/></div>');

		$('.row').last().find('.decrypt').click();
		var row_count = $('.row').size();
		//encrypts rows older than the first 5 rows
		if(row_count > 22){
			var el = $('.row').get(row_count-22);
			$(el).find('.encrypt').click();
		}
		scrollToBottom();
	});

	socket.on('updaterooms', function(rooms, current_room) {
		$('#rooms ul').empty();
		$.each(rooms, function(key, value) {
			if(value == current_room){
$('#rooms ul').append('<li><a href=\'#'+value+'\'>' + value + '</a></li>');
			}
			else {
$('#rooms ul').append('<li><a href=\'#'+value+'\' onclick="switchRoom(\''+value+'\')">' + value + '</a></div>');
			}
		});

		$('#rooms').tabs("refresh");
	});

	function switchRoom(room){
		socket.emit('switchRoom', room);
		$('#data').focus();
	}
	
	// on page ready
	$(function(){
		//initialize tabs
    		$( "#rooms" ).tabs();
		// when the client clicks SEND
		$('#datasend').click( function() {
			var message = $('#data').val();
			$('#data').val('');
			
			var pw = $('#password').val();
			
			message = sjcl.encrypt(pw, message);
			socket.emit('sendchat', message);
		});

		// when the client hits ENTER on their keyboard
		$('#data').keypress(function(e) {
			if(e.which == 13) {
				$('#datasend').click();
			}
		});

		//
		$(document).on('click','.decrypt', function() {
			$(this).addClass('encrypt');
			$(this).text('Encrypt');
			$(this).removeClass('decrypt');
			var emessage = $( this ).prev().text();
			var pw = $('#password').val();
			var message = sjcl.decrypt(pw, emessage);
			$( this ).prev().text(message);
			
		});
		$(document).on('click','.encrypt', function() {
			$(this).addClass('decrypt');
			$(this).text('Decrypt');
			$(this).removeClass('encrypt');
			var message = $( this ).prev().text();
			var pw = $('#password').val();
			var emessage = sjcl.encrypt(pw, message);
			$( this ).prev().text(emessage);
			
		});
		// Bind to the resize event of the window object
		$(window).on("resize", function () {
    $("#conversation").height($(document).height() - $('#rooms').height() - $('#dialog').height()-60 );
		}).trigger('resize');
		// Invoke the resize event onload
	});


function scrollToBottom(){
	$('#conversation').animate({ 
	   scrollTop: $('#conversation')[0].scrollHeight}, 
	   400, 
	   "easeOutQuint"
	);
}

</script>

<style>
.decrypt, .encrypt {float:right; clear:right; background:yellow;color:green;font-weight:bold}
</style>
</head>
<body>

<div id="rooms">
  <ul>
    <li><a href="#tabs-1">Global</a></li>
    <li><a href="#tabs-3">Information</a></li>
  </ul>
</div>

<div id="room1">
	<div style="padding:10px;">
	<div style="height:100%;overflow:auto;overflow-style:scrollbar;" id="conversation"></div>
	</div>
</div>
<div id="dialog">
	<input id="password" style="width:200px;" placeholder="password" type="text" value="abc"/>
	<br/>
	<input id="data" style="width:200px;" placeholder="Write here and press enter."/>
	<input id="datasend" type="button" value="send" />
</div>


</body>
</html>
